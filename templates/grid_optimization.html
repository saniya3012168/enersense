<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Grid Optimization - EnerSense</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='charts.js') }}"></script>
</head>
<body>
  <div class="container mt-4">
    <h2>Grid Optimization</h2>

    {% if msg %}
      <div class="alert alert-info">{{ msg }}</div>
      <a class="button" href="/">Back</a>
    {% else %}
      <div class="card p-3 mb-3">
        <p><strong>Demand (kWh):</strong> {{ demand }}</p>
        <p><strong>Available Solar (kWh):</strong> {{ solar_kwh }}</p>
        <p><strong>Renewable Used:</strong> {{ optimized.renewable_used_kWh }} kWh</p>
        <p><strong>Storage Used:</strong> {{ optimized.storage_used_kWh }} kWh</p>
        <p><strong>Grid Used:</strong> {{ optimized.grid_used_kWh }} kWh</p>
        <p><strong>Estimated Grid Loss:</strong> {{ optimized.grid_loss_kWh }} kWh</p>
        <p><strong>Total Cost ($):</strong> {{ optimized.total_cost_$ }}</p>
      </div>

      <div class="chart-container">
        <canvas id="gridChart"></canvas>
      </div>

      <h4 class="mt-3">Recommendations</h4>
      <ul>
        {% for r in optimized.recommendations %}
          <li>{{ r }}</li>
        {% endfor %}
      </ul>

      <a class="button" href="/">Back</a>

      <script>
        // render bar chart using charts.js helper or raw Chart.js if helper isn't available
        const labels = ['Renewable', 'Storage', 'Grid'];
        const values = [
          {{ optimized.renewable_used_kWh }},
          {{ optimized.storage_used_kWh }},
          {{ optimized.grid_used_kWh }}
        ];

        if (typeof renderChart === 'function') {
          renderChart('gridChart', 'bar', labels, [{
            label: 'Allocation (kWh)',
            data: values,
            backgroundColor: ['#4caf50','#ffb300','#f44336']
          }], { plugins: { legend: { display: false } }});
        } else {
          new Chart(document.getElementById('gridChart'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Allocation (kWh)',
                data: values,
                backgroundColor: ['#4caf50','#ffb300','#f44336']
              }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });
        }
      </script>
    {% endif %}
  </div>
</body>
</html>
